HOMEWORK 2
ТАБЛИЦЫ

CREATE TABLE Transactions
(   
  Client_id INT NOT NULL , 
  Report_date date NOT NULL,
  Txn_amount INT NOT NULL
);

CREATE TABLE Rates
(
  Report_date date NOT NULL,
  Ccy_code INT   NOT NULL,
  Ccy_rate DECIMAL(4,2)  NOT NULL
);

CREATE TABLE VSP_oper_data
(
  Client_id INT NOT NULL,
  Report_date date NOT NULL,
  VSP_Number INT NOT NULL,
  Txn_type text NOT NULL,
  Txn_amount INT NOT NULL
);

INSERT INTO VSP_oper_data
VALUES
(
1233455, '2017-05-02', 0123, 'credit', 5000
)
INSERT INTO VSP_oper_data 
VALUES
(
1288455, '2017-12-02', 1212, 'credit', 15000
)

INSERT INTO VSP_oper_data 
VALUES
(
1288455, '2017-05-02', 1332, 'debit', 11050
)


INSERT INTO VSP_oper_data 
VALUES
(
1333855, '2017-01-02', 4321, 'debit', 7092
)

INSERT INTO VSP_oper_data 
VALUES
(
1333855, '2017-01-02', 4321, 'credit', 8992
)


1 ЗАДАЧА  
ЗАДАНИЕ

Table: Transactions
Client_id	Report_date	Txn_amount
123	        2017.01.01	  50000

Table: Rates
Report_date	Ccy_code	CCy_rate
2016.12.30	840	        60,58
2017.01.09	840	        61,01

Задание: Напишите sql запрос, который будет переводить сумму транзакций в usd (ccy_code = 840) 
с учетом того, что в таблице rates данные только за рабочие дни. 
Транзакции, совершенные в выходные, пересчитываются по курсу последнего рабочего дня 
перед праздником/выходным. Результат: Клиент, дата, сумма операций в usd.

Решение:
--Берем lient_id, Report_date, sum_usd из доп таблицы
SELECT Client_id, Report_date, sum_usd
FROM
(
-- в ней нуммеруем строки Transactions.Report_date с помощью PARTITION BY и выставляем в порядке убывания 
  SELECT 
    Client_id, 
	Transactions.Report_date,
	Transactions.Txn_amount*Rates.Ccy_rate AS sum_usd, 
	ROW_NUMBER() OVER (PARTITION BY Transactions.Report_date ORDER BY Rates.Report_date DESC) AS ROW_NUM
     FROM Transactions
--Присоединяем выборку к Rates и ограничиваем ее так чтобы время из Rates было меньше времени из Transactions
        JOIN Rates
        ON Rates.Report_date <= Transactions.Report_date
--Так же ограничиваем выборку по Ccy_code = 840 что бы выбрало только код для USD
     WHERE Ccy_code = 840 
) AS T
WHERE ROW_NUM = 1

2 ЗАДАЧА 

ЗАДАНИЕ

Table: VSP_oper_data
Client_id	 Report_date	   VSP_Number	Txn_type	Txn_amount
1233455	         2017.05.02	   1234/0123	deposit	          10000

В таблице VSP_oper_data txn_type принимает значения debit, credit
Задание: напишите sql запрос, который для каждого клиента выводит сумму debit, credit операций и 
последнее посещенное VSP по месяцам. 
Результат представьте в виде: 
Client_id	Report_date	Debit_amount	Credit_amount	Last_VSP
				

решение:

-- Через ALTER TABLE устраняем конфликт  данных int и text

ALTER TABLE VSP_oper_data
ALTER COLUMN Txn_type NVARCHAR(MAX)
GO
-- Через доп таблицу X выбираем все и Debit_amount

WITH X AS
(
  SELECT 
  *, 
  COALESCE(SUM(Txn_amount) 
    OVER ( PARTITION BY  'debit' ORDER BY Client_id,Txn_type
    ROWS between UNBOUNDED PRECEDING and CURRENT ROW), 
    0) AS Debit_amount FROM VSP_oper_data
  WHERE Txn_type = 'debit'
)
-- Через доп таблицу I выбираем все и Credit_amount
,
I AS
(
  SELECT 
  *, 
  COALESCE(SUM(Txn_amount) 
    OVER ( PARTITION BY  'credit' ORDER BY Client_id,Txn_type
    ROWS between UNBOUNDED PRECEDING and CURRENT ROW), 
    0) AS credit_amount FROM VSP_oper_data
  WHERE Txn_type = 'credit'
 )
 --Совмещаем X и I так как взять Debit_amount и Credit_amount через  UNION не получится
 ,
 XI AS
 (
 SELECT 
   I.Client_id, 
   credit_amount,
   Debit_amount 
 FROM I JOIN X ON I.Client_id = X.Client_id 
 )
 -- Выбираем все что нам нужно Ограничивая выборку VSP_Number так как нам нужны самые последние посещения
 -- Так же для этого берем MAX(MONTH(Report_date) как последние посещения 
 SELECT DISTINCT
   VSP_oper_data.Client_id, 
   MAX(MONTH(Report_date)) AS Report_date,
   credit_amount,Debit_amount,
   VSP_oper_data.VSP_Number AS Last_VSP 
 FROM VSP_oper_data JOIN XI ON VSP_oper_data.Client_id = XI.Client_id 
  WHERE VSP_oper_data.VSP_Number IN 
 (SELECT 
  VSP_Number 
 FROM VSP_oper_data 
  WHERE Report_date IN
 (SELECT DISTINCT TOP 3 Report_date 
  FROM  VSP_oper_data))
 
--группируем по выборке
 GROUP BY 
   VSP_oper_data.Client_id,
   XI.credit_amount,
   XI.Debit_amount,
   VSP_oper_data.VSP_Number